{% extends 'base.html' %}
{% block main %}
    <h1>Report a Swarm</h1>
    <p>lorem ipsum lorem ipsum lorem ipsum lorem ipsum lorem ipsum lorem ipsum lorem ipsum lorem ipsum lorem ipsum lorem
        ipsum </p>
    {% if errors %}
    <div class="card border-danger">
    <div class="card-header bg-danger">
        Errors
        </div><div class="card-body">
          {% for e in errors %}
          <dd>{{ e }}</dd>
          {% endfor %}
      </div>
    </div>
    <p>&nbsp;</p>
    {% endif %}
    <form method="post" id="report-form">
        {% csrf_token %}
        <div class="form-group">
            <label for="">Name <sup class="text-danger">*</sup></label>
            <input type="text" class="form-control" id="" placeholder="Your name" required value="{{ report.name }}" name="name">
        </div>
        <div class="form-group">
            <label for="">Email <sup class="text-danger">*</sup></label>
            <input type="email" class="form-control" id="" placeholder="Your email address" required value="{{ report.email }}" name="email">
        </div>
        <div class="form-group">
            <label for="">Phone</label>
            <input type="tel" class="form-control" id="" placeholder="Your phone number" value="{{ report.phone }}" name="phone">
        </div>
        <div class="form-group">
            <label for="">Swarm Location <sup class="text-danger">*</sup></label>
            <div id="map" style="width: 100%;height: 300px;"></div>
            <div class="text-right"><small><a href="#" onclick="return locateMe()" id="ahref-locate-me">Locate me</a></small></div>
        </div>
        <div class="form-group">
            <label for="">Swarm Location Details (e.g. Address)</label>
            <textarea class="form-control" placeholder="Provide details about the location" style="height:150px" name="location">{{ report.location }}</textarea>
        </div>
        <div class="form-group">
            <a href="#" class="btn btn-lg btn-primary" onclick="return submitMe()">
                Submit
            </a>
        </div>
    </form>

{% endblock %}

{% block script %}
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB_NdhKo8z6dAnomohyzYKoSmrkQ0JNjoM"></script>
<script src="https://unpkg.com/location-picker/dist/location-picker.min.js"></script>
<script src="https://www.google.com/recaptcha/api.js?render=6LflQfkUAAAAAD9qBbTMGbbi0MzwT0v8kvetjH79"></script>
<script>
window.locationPickerObj = false;
window.defaultLocation = {
    lat: 44.2312,
    lng: -76.4860
};

function initLocationPicker(loc) {
    if (window.locationPickerObj) {
        window.locationPickerObj.map.setCenter(loc);
    } else {
        // see https://cyphercodes.github.io/location-picker/
        window.locationPickerObj = new locationPicker('map', loc, {
            zoom: 15,
            gestureHandling: 'greedy'
        });
    }
}

function locateMe() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
        initLocationPicker({
            lat: position.coords.latitude,
            lng: position.coords.longitude
        });
    }, function(e) {
        switch(e.code) {
            case 1: $('#ahref-locate-me').replaceWith('Getting your location: permission denied'); break;
            case 2: $('#ahref-locate-me').replaceWith('Getting your location: position unavailable'); break;
            case 3: $('#ahref-locate-me').replaceWith('Getting your location: timeout'); break;
        }
        initLocationPicker(defaultLocation);
    });
  } else {
    $('#ahref-locate-me').replaceWith("Geolocation is not supported by this browser");
    initLocationPicker(defaultLocation);
  }
  return false;
}

$(locateMe);

function submitMe() {
    grecaptcha.execute('{{ recaptcha_key }}', {action: 'report'}).then(function(token) {
        var pos = window.locationPickerObj.getMarkerPosition();
        $('#report-form')
            .append('<input type="hidden" name="recaptcha" value="' + token + '">')
            .append('<input type="hidden" name="latitude" value="' + pos.lat + '">')
            .append('<input type="hidden" name="longitude" value="' + pos.lng + '">')
            .submit();
    });
    return false;
}

</script>
{% endblock %}